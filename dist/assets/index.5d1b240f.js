var e=Object.defineProperty,a=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,s=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l;import{r as i,o,h as r,g as d,f as n,c as u,x as c,q as p,y as m,ac as h,v as g,M as b,N as f,F as D,i as w,t as _}from"./vendor.107e8656.js";import{w as y,g as V,a as P,b as v}from"./product.07925991.js";import{P as j}from"./index.9d466a4b.js";import{k as C,_ as U,v as F}from"./index.136e6deb.js";import{g as k}from"./role.075b9fec.js";import{g as E}from"./station.a9acb3c1.js";import{m as A}from"./message.96b00d49.js";import{_ as S}from"./lodash.bd96a4e5.js";import{m as x}from"./self.e8057f1b.js";const O={name:"ChangePass",props:{isChange:{type:Boolean,require:!0},isDialog:{type:Boolean,require:!0}},data(){return{formData:{oldPass:"",pass:"",checkPass:""},rules:{oldPass:[{required:this.isChange,message:"必填",trigger:"blur"}],pass:[{required:!0,message:"必填",trigger:"blur"},{validator:(e,a,t)=>{""===a?t(new Error("请输入密码")):(""!==this.formData.checkPass&&this.$refs.ruleFormPass.validateField("checkPass"),t())},min:3}],checkPass:[{required:!0,message:"必填",trigger:"blur"},{validator:(e,a,t)=>{""===a?t(new Error("请再次输入密码")):a!==this.formData.pass?t(new Error("两次输入密码不一致!")):t()},min:3}]}}},mounted(){this.$refs.ruleFormPass.clearValidate()},methods:{cancelFun(){this.$emit("wwpass-cancel",this.formData)},handleSubmitFn(){this.$emit("wwpass-confirm",this.formData)},confirmFun(e){this.$refs[e].validate((e=>{if(!e)return!1;this.handleSubmitFn()}))}}},$={class:"pass-container"},T={style:{"text-align":"right"}},R=m("退出"),q=m("提交");const z={email:"",username:"",password:"",password_re:"",comment:"",position_id:[],position_ischange:!1,role_id:[],role_ischange:!1,project_id:[],project_ischange:!1,product_id:[],product_ischange:!1},B={mixins:[x],components:{Pagination:j,WwChangePass:U(O,[["render",function(e,a,t,l,s,m){const h=i("el-input"),g=i("el-form-item"),b=i("el-form"),f=i("el-button");return o(),r("div",$,[d(b,{ref:"ruleFormPass",model:s.formData,rules:s.rules,"label-width":"150px","label-position":"left"},{default:n((()=>[t.isChange?(o(),u(g,{key:0,label:"旧密码",prop:"oldPass",autocomplete:"off"},{default:n((()=>[d(h,{modelValue:s.formData.oldPass,"onUpdate:modelValue":a[0]||(a[0]=e=>s.formData.oldPass=e),placeholder:"",type:"password"},null,8,["modelValue"])])),_:1})):c("v-if",!0),d(g,{label:"新密码",prop:"pass",autocomplete:"off"},{default:n((()=>[d(h,{modelValue:s.formData.pass,"onUpdate:modelValue":a[1]||(a[1]=e=>s.formData.pass=e),placeholder:"",type:"password"},null,8,["modelValue"])])),_:1}),d(g,{label:"再次输入",prop:"checkPass",autocomplete:"off"},{default:n((()=>[d(h,{modelValue:s.formData.checkPass,"onUpdate:modelValue":a[2]||(a[2]=e=>s.formData.checkPass=e),placeholder:"",type:"password"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"]),p("div",T,[t.isDialog?(o(),u(f,{key:0,type:"danger",onClick:m.cancelFun},{default:n((()=>[R])),_:1},8,["onClick"])):c("v-if",!0),d(f,{type:"primary",onClick:a[3]||(a[3]=e=>m.confirmFun("ruleFormPass"))},{default:n((()=>[q])),_:1})])])}]])},directives:{waves:y},filters:{handlePositions(e){}},data(){return{dialogVisiblePass:!1,dialogVisible:!1,dialogType:"new",busData:{options:{position:[],role:[],project:[],product:[],productArr:[]},oldData:{},data:S.cloneDeep(z),rules:{email:[{required:!0,message:"必填",trigger:["change","blur"]},{validator:(e,a,t)=>{""===a?t(new Error("请输入邮箱")):F(a)?t():t(new Error("请输入正确的邮箱格式"))}}],username:[{required:!0,message:"必填",trigger:["change","blur"]},{min:6,max:50,message:"长度在 6 到 50 个字符",trigger:"blur"}],password:[{required:!0,message:"必填",trigger:["change","blur"]},{min:8,max:16,message:"长度在 8 到 16 个字符",trigger:"blur"},{validator:(e,a,t)=>{""===a?t(new Error("请输入密码")):(""!==this.busData.data.password_re&&this.$refs.ruleForm.validateField("password_re"),t())}}],password_re:[{required:!0,message:"必填",trigger:["change","blur"]},{min:8,max:16,message:"长度在 8 到 16 个字符",trigger:"blur"},{validator:(e,a,t)=>{""===a?t(new Error("请再次输入密码")):a!==this.busData.data.password?t(new Error("两次输入密码不一致!")):t()}}],comment:[{required:!1,message:"必填",trigger:["change","blur"]}],role_id:[{required:!1,message:"必填",trigger:["change","blur"]}],position_id:[{required:!0,message:"必填",trigger:["change","blur"]}],project_id:[{required:!0,message:"必填",trigger:["change","blur"]}],product_id:[{required:!0,message:"必填",trigger:["change","blur"]}]}},control:{search:""},list:[],pagination:{pageSizes:["10","20","40","100"],total:1,listQuery:{page:1,limit:20,importance:void 0,title:void 0,type:void 0,sort:"+id"}}}},computed:((e,i)=>{for(var o in i||(i={}))t.call(i,o)&&s(e,o,i[o]);if(a)for(var o of a(i))l.call(i,o)&&s(e,o,i[o]);return e})({},h(["rolesMap","element"])),watch:{"busData.data.project":{handler(e,a){},immediate:!1}},created(){this.getConfig(),this.init();g()},methods:{handleProjectFn(e){return this.busData.options.project.filter((a=>e.includes(a.id)))},changeUserStatus(e,a){},async getConfig(){const{data:e}=await V();this.busData.options.project=e;const{data:a}=await P({name:"",page:1,limit:999,project_id:"",order:"desc"});this.busData.options.productArr=a.list;const{data:t}=await E();this.busData.options.position=t;const{data:l}=await k();this.busData.options.role=l},init(){this.getList()},getUserProject(e){return this.busData.options.project.filter((a=>e.includes(a.id))).map((e=>e.name)).join(",")},getUserProduct(e){return this.busData.options.productArr.filter((a=>e.includes(a.id))).map((e=>e.name)).join(",")},getUserPosition(e){return this.busData.options.position.filter((a=>e.includes(a.id))).map((e=>e.name)).join(",")},async getList(){const e={username:this.control.search,page:this.pagination.listQuery.page,limit:this.pagination.listQuery.limit},{data:a}=await function(e){return C({url:"/users",method:"get",data:e})}(e);this.list=a.data,this.pagination.total=a.paging.count},handleSearch(){this.pagination.listQuery.page=1,this.getList()},handleCreate(){this.dialogType="new",this.dialogVisible=!0,this.clearBusData()},async handleEdit(e){this.dialogType="edit",this.dialogVisible=!0,this.clearBusData(),this.busData.data.id=e.row.id;const{data:a}=await(t=this.busData.data.id,C({url:`/users/${t}`,method:"get"}));var t;this.busData.oldData=S.cloneDeep(a),this.busData.data=Object.assign({},this.busData.data,S.cloneDeep(a)),this.choiceProject()},confirmFun(e){this.$refs[e].validate((e=>{if(!e)return!1;this.handleSubmitFn()}))},async handleSubmitFn(){if("new"===this.dialogType){const a=S.cloneDeep(this.busData.data),t=await(e=a,C({url:"/users",method:"post",data:e})).catch((e=>{const{data:{data:a}}=e;for(const t in a)if(Object.hasOwnProperty.call(a,t)){const e=a[t];this.$message.error(e)}}));t&&(A(t),this.getList(),this.clearBusData(),this.dialogVisible=!1)}var e;if("edit"===this.dialogType){const e=S.cloneDeep(this.busData.data),a=await function(e,a){return C({url:`/users/${e}`,method:"put",data:a})}(this.busData.data.id,e);a&&(A(a),this.clearBusData(),this.dialogVisible=!1)}},handleDelete(e){this.$confirm("确定删除?","警告",{confirmButtonText:"Confirm",cancelButtonText:"Cancel",type:"warning"}).then((async()=>{this.list.splice(e.$index,1),this.$message({type:"success",message:"Delete succed!"})})).catch((e=>{}))},clearBusData(){this.busData.data=S.cloneDeep(z),this.busData.oldData={},this.$nextTick((()=>{this.$refs.ruleForm.clearValidate()}))},async changeStatus(e,a){const t={id:a.id,status:a.status};var l,s;await(l=a.id,s=t,C({url:`/users/status/${l}`,method:"patch",data:s}))},handleEditPass(e){this.dialogVisiblePass=!0,this.busData.data.id=e.row.id},cancelPass(e){this.dialogVisiblePass=!1},async confirmPass(e){const a={password:e.pass,password_re:e.checkPass},t=await function(e,a){return C({url:`/users/pwd/${e}`,method:"patch",data:a})}(this.busData.data.id,a);A(t),this.dialogVisiblePass=!1},selectChangeFn(e){this.busData.data[`${e}_ischange`]=!0},async choiceProject(){const e=[...this.busData.data.project_id],a=[];if(0!==e.length){await Promise.all(e.map((async e=>{const{data:t}=await v(e);return 0!==t.product.length&&t.product.forEach((e=>{a.push(e)})),e})));const t=Array.from(new Set(a));this.busData.options.product=this.handleProductsFn(t)}},handleProductsFn(e){const a=[];return this.busData.options.productArr.map((t=>{e.includes(t.id)&&a.push(t)})),a},unSelectedAll(){this.busData.data.product_id=[],this.busData.data.product_ischange=!0},selectAll(){const e=[];this.busData.options.product.map((a=>{e.push(a.id)})),this.busData.data.product_id=e,this.busData.data.product_ischange=!0}}},L={class:"app-container"},M=m("全选"),Q=m("清空"),W={style:{"text-align":"right"}},I=m("取消"),N=m("确定"),J={class:"w100 control-box flex jc-end"},G={class:"flex flex-end"},H=m("搜索"),K=m("添加用户"),X={class:"flex"},Y=m("修改"),Z=m("修改密码"),ee=m("删除"),ae={class:"w100 flex"};var te=U(B,[["render",function(e,a,t,l,s,h){const g=i("el-input"),y=i("el-form-item"),V=i("el-option"),P=i("el-select"),v=i("el-button"),j=i("el-form"),C=i("el-dialog"),U=i("ww-change-pass"),F=i("el-table-column"),k=i("el-switch"),E=i("el-table"),A=i("pagination");return o(),r("div",L,[c(" dialog "),d(C,{modelValue:s.dialogVisible,"onUpdate:modelValue":a[17]||(a[17]=e=>s.dialogVisible=e),title:"edit"===s.dialogType?"Edit User":"New User",width:"80%"},{default:n((()=>[d(j,{ref:"ruleForm",model:s.busData.data,rules:s.busData.rules,"label-width":"150px","label-position":"left"},{default:n((()=>[d(y,{label:"邮箱",prop:"email"},{default:n((()=>[d(g,{modelValue:s.busData.data.email,"onUpdate:modelValue":a[0]||(a[0]=e=>s.busData.data.email=e),placeholder:"邮箱",disabled:"edit"===s.dialogType},null,8,["modelValue","disabled"])])),_:1}),d(y,{label:"用户名",prop:"username"},{default:n((()=>[d(g,{modelValue:s.busData.data.username,"onUpdate:modelValue":a[1]||(a[1]=e=>s.busData.data.username=e),placeholder:"用户名必须大于6位"},null,8,["modelValue"])])),_:1}),"new"===s.dialogType?(o(),r(D,{key:0},[d(y,{label:"密码",prop:"password",autocomplete:"off"},{default:n((()=>[d(g,{modelValue:s.busData.data.password,"onUpdate:modelValue":a[2]||(a[2]=e=>s.busData.data.password=e),type:"password",placeholder:""},null,8,["modelValue"])])),_:1}),d(y,{label:"再次输入密码",prop:"password_re",autocomplete:"off"},{default:n((()=>[d(g,{modelValue:s.busData.data.password_re,"onUpdate:modelValue":a[3]||(a[3]=e=>s.busData.data.password_re=e),type:"password",placeholder:""},null,8,["modelValue"])])),_:1})],64)):c("v-if",!0),d(y,{label:"描述",prop:"comment"},{default:n((()=>[d(g,{modelValue:s.busData.data.comment,"onUpdate:modelValue":a[4]||(a[4]=e=>s.busData.data.comment=e),placeholder:"描述"},null,8,["modelValue"])])),_:1}),d(y,{label:"岗位权限",prop:"position_id"},{default:n((()=>[d(P,{modelValue:s.busData.data.position_id,"onUpdate:modelValue":a[5]||(a[5]=e=>s.busData.data.position_id=e),filterable:"",multiple:"",class:"w100",placeholder:"岗位权限",disabled:!e.judgePermissionElementFn("A-AU-USER-FORM-POSITION-C"),onChange:a[6]||(a[6]=e=>h.selectChangeFn("position"))},{default:n((()=>[(o(!0),r(D,null,w(s.busData.options.position,(e=>(o(),u(V,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1}),d(y,{label:"角色权限",prop:"role_id"},{default:n((()=>[d(P,{modelValue:s.busData.data.role_id,"onUpdate:modelValue":a[7]||(a[7]=e=>s.busData.data.role_id=e),filterable:"",multiple:"",class:"w100",placeholder:"角色权限",disabled:!e.judgePermissionElementFn("A-AU-USER-FORM-ROLE-C"),onChange:a[8]||(a[8]=e=>h.selectChangeFn("role"))},{default:n((()=>[(o(!0),r(D,null,w(s.busData.options.role,(e=>(o(),u(V,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1}),d(y,{label:"所属项目组",prop:"project_id"},{default:n((()=>[d(P,{modelValue:s.busData.data.project_id,"onUpdate:modelValue":a[9]||(a[9]=e=>s.busData.data.project_id=e),filterable:"",multiple:"",class:"w100",placeholder:"所属项目组",disabled:!e.judgePermissionElementFn("A-AU-USER-FORM-PROJECT-C"),onChange:a[10]||(a[10]=e=>(h.selectChangeFn("project"),h.choiceProject()))},{default:n((()=>[(o(!0),r(D,null,w(s.busData.options.project,(e=>(o(),u(V,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1}),d(y,{label:"可查看产品",prop:"product_id"},{default:n((()=>[d(P,{modelValue:s.busData.data.product_id,"onUpdate:modelValue":a[13]||(a[13]=e=>s.busData.data.product_id=e),filterable:"",multiple:"",class:"w100",placeholder:"默认全部",disabled:!e.judgePermissionElementFn("A-AU-USER-FORM-PRODUCT-C"),onChange:a[14]||(a[14]=e=>h.selectChangeFn("product"))},{default:n((()=>[d(v,{style:{float:"left","margin-left":"20px","z-index":"1"},type:"primary",plain:"",onClick:a[11]||(a[11]=e=>h.selectAll())},{default:n((()=>[M])),_:1}),d(v,{style:{float:"right","margin-right":"20px","z-index":"1"},type:"danger",plain:"",onClick:a[12]||(a[12]=e=>h.unSelectedAll())},{default:n((()=>[Q])),_:1}),(o(!0),r(D,null,w(s.busData.options.product,(e=>(o(),u(V,{key:e.id,label:e.name,value:e.id,style:{clear:"both"}},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})])),_:1},8,["model","rules"]),p("div",W,[d(v,{type:"danger",onClick:a[15]||(a[15]=e=>s.dialogVisible=!1)},{default:n((()=>[I])),_:1}),d(v,{type:"primary",onClick:a[16]||(a[16]=e=>h.confirmFun("ruleForm"))},{default:n((()=>[N])),_:1})])])),_:1},8,["modelValue","title"]),c(" dialog "),c(" dialog "),d(C,{modelValue:s.dialogVisiblePass,"onUpdate:modelValue":a[18]||(a[18]=e=>s.dialogVisiblePass=e),title:"修改密码",width:"80%"},{default:n((()=>[s.dialogVisiblePass?(o(),u(U,{key:0,is_change:!1,"is-dialog":!0,onWwpassCancel:h.cancelPass,onWwpassConfirm:h.confirmPass},null,8,["onWwpassCancel","onWwpassConfirm"])):c("v-if",!0)])),_:1},8,["modelValue"]),c(" dialog "),p("div",J,[p("div",G,[c(' <el-input placeholder="请输入内容" v-model="control.search" class="input-with-select">\n          <el-button type="primary" slot="append">搜索</el-button>\n        </el-input> '),d(g,{modelValue:s.control.search,"onUpdate:modelValue":a[19]||(a[19]=e=>s.control.search=e),class:"mr-10",placeholder:"请输入用户名"},null,8,["modelValue"]),d(v,{type:"primary",onClick:h.handleSearch},{default:n((()=>[H])),_:1},8,["onClick"]),e.judgePermissionElementFn("A-AU-USER-ADD-V")?(o(),u(v,{key:0,type:"primary",onClick:h.handleCreate},{default:n((()=>[K])),_:1},8,["onClick"])):c("v-if",!0)])]),d(E,{data:s.list,style:{width:"100%","margin-top":"30px"},border:""},{default:n((()=>[d(F,{align:"center",label:"邮箱"},{default:n((e=>[m(_(e.row.email),1)])),_:1}),d(F,{align:"center",label:"用户名"},{default:n((e=>[m(_(e.row.username),1)])),_:1}),d(F,{align:"center",label:"所属项目组"},{default:n((e=>[m(_(h.getUserProject(e.row.project_id)),1)])),_:1}),d(F,{align:"center",label:"用户权限"},{default:n((e=>[m(_(h.getUserPosition(e.row.position_id)),1)])),_:1}),d(F,{align:"center",label:"可查看产品"},{default:n((e=>[m(_(e.row.product_id),1)])),_:1}),d(F,{align:"center",label:"创建日期"},{default:n((e=>[m(_(e.row.create_date),1)])),_:1}),d(F,{align:"center",label:"最后访问日期"},{default:n((e=>[m(_(e.row.update_date),1)])),_:1}),d(F,{align:"center",label:"用户状态"},{default:n((a=>[e.judgePermissionElementFn("A-AU-USER-STATUS-V")?(o(),u(k,{key:0,modelValue:a.row.status,"onUpdate:modelValue":e=>a.row.status=e,"active-value":"1","inactive-value":"2",onChange:e=>h.changeStatus(e,a.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])):c("v-if",!0)])),_:1}),d(F,{align:"center",label:"操作",width:"250"},{default:n((a=>[p("div",X,[e.judgePermissionElementFn("A-AU-USER-EDIT-V")?(o(),u(v,{key:0,type:"primary",size:"small",onClick:e=>h.handleEdit(a)},{default:n((()=>[Y])),_:2},1032,["onClick"])):c("v-if",!0),e.judgePermissionElementFn("A-AU-USER-PASS-V")?(o(),u(v,{key:1,type:"primary",size:"small",onClick:e=>h.handleEditPass(a)},{default:n((()=>[Z])),_:2},1032,["onClick"])):c("v-if",!0),e.judgePermissionElementFn("A-AU-USER-DEL-V")?(o(),u(v,{key:2,type:"danger",size:"small",onClick:e=>h.handleDelete(a)},{default:n((()=>[ee])),_:2},1032,["onClick"])):c("v-if",!0)])])),_:1})])),_:1},8,["data"]),c(" pagination "),p("div",ae,[b(d(A,{total:s.pagination.total,"page-sizes":s.pagination.pageSizes,page:s.pagination.listQuery.page,limit:s.pagination.listQuery.limit,onPagination:h.init},null,8,["total","page-sizes","page","limit","onPagination"]),[[f,s.pagination.total]])])])}]]);export{te as default};
