var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,s=(t,a,i)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i;import{K as n,r as d,o as r,c as h,h as c,x as p,v as u,k as m,i as f,y as D,t as g}from"./vendor-577b9c97.js";import{g as b,a as y,s as C,b as A}from"./power-c18dc0f4.js";import{h as w}from"./format-15e3f823.js";import{_ as k}from"./lodash-9274f865.js";import{_ as T}from"./index-8c05bc60.js";import{m as _}from"./message-0de2106d.js";import{m as v}from"./self-82e86ced.js";import"./moment-9bd84dc2.js";const j={class:""};const V={element:[],menu:[],operation:[],permission:[]},x={components:{RoleTree:T({props:{title:{default:"title",type:String},data:{default:()=>[],type:Array},item:{default:()=>({}),type:Object},choice:{default:()=>[],type:Array},name:{default:"name",type:String},date:{default:0,type:Number}},data:()=>({filterApiText:"",list:[],choiceArr:[],checkStrictly:!1,defaultProps:{children:"children",label:"label"}}),computed:{handleTree(){return w(this.list)},handleRef(){return`tree${this.name}`}},watch:{date(){this.init()},choice:{immediate:!0,handler(e,t){this.$nextTick((()=>{this.$refs[this.handleRef].setCheckedKeys([]),e&&e.forEach((e=>{const t=this.$refs[this.handleRef].getNode(e);t&&t.isLeaf&&this.$refs[this.handleRef].setChecked(t,!0)}))}))}},filterApiText(e){this.$refs[this.handleRef]&&this.$refs[this.handleRef].filter(e)}},created(){this.list=k.cloneDeep(this.data)},methods:{async init(){this.filterApiText=""},changeOneFn(e,t){const a=[...this.$refs[this.handleRef].getCheckedKeys(),...this.$refs[this.handleRef].getHalfCheckedKeys()];this.$emit("changeChoiceData",this.name,a)},filterApiNode(e,t){return!e||t[this.defaultProps.label].includes(e)},checkApiTree(e,t,a){const i=this.handleChoiceApiDataPermissionID,l=this.dialogData.treeData.choiceApiData.find((t=>t.permission_id===e.id));var o=null==l?void 0:l.id;t?(this.dialogData.treeData.choiceApiDataAdd.includes(e.id)||i.includes(e.id)||this.dialogData.treeData.choiceApiDataAdd.push(e.id),this.dialogData.treeData.choiceApiDataAdd.includes(o)&&(this.dialogData.treeData.choiceApiDataDel=this.dialogData.treeData.choiceApiDataDel.filter((e=>e!==o)))):(this.dialogData.treeData.choiceApiDataDel.includes(o)||l&&this.dialogData.treeData.choiceApiDataDel.push(o),this.dialogData.treeData.choiceApiDataAdd.includes(e.id)&&(this.dialogData.treeData.choiceApiDataAdd=this.dialogData.treeData.choiceApiDataAdd.filter((t=>t!==e.id))))},generateRoutes(e,t="/"){const a=[];for(let{route:i}of e){if(i.hidden)continue;const e=this.onlyOneShowingChild(i.children,i);i.children&&e&&!i.alwaysShow&&(i=e);const l={path:n.resolve(t,i.path),title:i.title,name:i.name};i.children&&(l.children=this.generateRoutes(i.children,l.path)),a.push(l)}return a},generateArr(e){let t=[];return e.forEach((e=>{if(t.push(e),e.children){const a=this.generateArr(e.children);a.length>0&&(t=[...t,...a])}})),t},generateTree(e,t="/",a){const i=[];for(const l of e){const e=n.resolve(t,l.path);l.children&&(l.children=this.generateTree(l.children,e,a)),(a.includes(e)||l.children&&l.children.length>=1)&&i.push(l)}return i},onlyOneShowingChild(e=[],d){let r=null;const h=e.filter((e=>!e.hidden));return 1===h.length?(r=h[0],r.path=n.resolve(d.path,r.path),r):0===h.length&&(c=((e,t)=>{for(var a in t||(t={}))l.call(t,a)&&s(e,a,t[a]);if(i)for(var a of i(t))o.call(t,a)&&s(e,a,t[a]);return e})({},d),r=t(c,a({path:"",noShowingChildren:!0})),r);var c}}},[["render",function(e,t,a,i,l,o){const s=d("el-input"),n=d("el-tree"),m=d("el-form-item"),f=d("el-form");return r(),h(f,{"label-width":"150px","label-position":"top"},{default:c((()=>[p(m,{label:a.title},{default:c((()=>[u("div",j,[p(s,{modelValue:l.filterApiText,"onUpdate:modelValue":t[0]||(t[0]=e=>l.filterApiText=e),class:"w100",placeholder:"输入关键字进行过滤"},null,8,["modelValue"]),p(n,{ref:o.handleRef,data:o.handleTree,props:l.defaultProps,"show-checkbox":"","node-key":"id",class:"permission-tree","default-checked-keys":l.choiceArr,"filter-node-method":o.filterApiNode,"default-expand-all":!0,onCheck:o.changeOneFn},null,8,["data","props","default-checked-keys","filter-node-method","onCheck"])])])),_:1},8,["label"])])),_:1})}]])},mixins:[v],data:()=>({date:"",list:[],data:{},dialogVisible:!1,dialogType:"",busData:{item:{type:""},choiceData:{menu:[],element:[],operation:[]}}}),created(){this.getList()},methods:{async getList(){const{data:e}=await b();this.data=e,this.list=e.permission},clearBusData(){this.busData.choiceData=k.cloneDeep(V)},handleCreate(){this.dialogType="new",this.busData.item.type="",this.clearBusData(),this.dialogVisible=!0;const e=new Date;this.date=e.getTime()},async handleEdit(e){this.dialogType="edit",this.busData.item=e.row;const{data:t}=await y(this.busData.item.id);this.busData.choiceData=t,this.dialogVisible=!0;const a=new Date;this.date=a.getTime()},handleDelete(e){},roleChangeChoice(e,t){this.busData.choiceData[e]=t},async submitFn(){if("new"===this.dialogType){const e={type:this.busData.item.type,menu_id:this.busData.choiceData.menu,element_id:this.busData.choiceData.element,operation_id:this.busData.choiceData.operation},t=await C(e);t&&_(t),this.getList()}if("edit"===this.dialogType){const e={permission_id:this.busData.item.id,menu_id:this.busData.choiceData.menu,element_id:this.busData.choiceData.element,operation_id:this.busData.choiceData.operation},t=await A(this.busData.item.id,e);t&&_(t)}this.dialogVisible=!1}}},P={class:"app-container"},O=D(" 新建 "),R=D(" 修改 "),E=D(" 删除 "),$={class:"flex jc-between ai-start"},S={slot:"footer",class:"dialog-footer"},F=D(" 取 消 "),N=D(" 确 定 ");var I=T(x,[["render",function(e,t,a,i,l,o){const s=d("el-button"),n=d("el-table-column"),b=d("el-table"),y=d("el-input"),C=d("el-form-item"),A=d("el-form"),w=d("role-tree"),k=d("el-dialog");return r(),m("div",P,[e.judgePermissionElementFn("A-AP-ADD-V")?(r(),h(s,{key:0,type:"primary",onClick:o.handleCreate},{default:c((()=>[O])),_:1},8,["onClick"])):f("v-if",!0),p(b,{data:l.list,style:{width:"100%","margin-top":"30px"},border:""},{default:c((()=>[p(n,{align:"center",label:"ID"},{default:c((e=>[D(g(e.row.id),1)])),_:1}),p(n,{align:"center",label:"Type"},{default:c((e=>[D(g(e.row.type),1)])),_:1}),p(n,{align:"center",label:"Operations"},{default:c((t=>[e.judgePermissionElementFn("A-AP-EDIT-V")?(r(),h(s,{key:0,type:"primary",size:"small",onClick:e=>o.handleEdit(t)},{default:c((()=>[R])),_:2},1032,["onClick"])):f("v-if",!0),e.judgePermissionElementFn("A-AP-DEL-V")?(r(),h(s,{key:1,type:"danger",size:"small",onClick:e=>o.handleDelete(t)},{default:c((()=>[E])),_:2},1032,["onClick"])):f("v-if",!0)])),_:1})])),_:1},8,["data"]),p(k,{modelValue:l.dialogVisible,"onUpdate:modelValue":t[2]||(t[2]=e=>l.dialogVisible=e),title:"edit"===l.dialogType?"Edit Role":"New Role",width:"90%"},{default:c((()=>[p(A,{"label-width":"150px","label-position":"left"},{default:c((()=>[p(C,{label:"Name"},{default:c((()=>[p(y,{modelValue:l.busData.item.type,"onUpdate:modelValue":t[0]||(t[0]=e=>l.busData.item.type=e),placeholder:"Role Name",disabled:"edit"===l.dialogType},null,8,["modelValue","disabled"])])),_:1})])),_:1}),u("div",$,[p(w,{ref:"roleroute",item:l.busData.item,data:l.data.menu,date:l.date,choice:l.busData.choiceData.menu,title:"路由权限",name:"menu",class:"col-auto-8 m0-10",onChangeChoiceData:o.roleChangeChoice},null,8,["item","data","date","choice","onChangeChoiceData"]),p(w,{ref:"rolebutton",item:l.busData.item,data:l.data.element,date:l.date,choice:l.busData.choiceData.element,title:"按钮权限",name:"element",class:"col-auto-8 m0-10",onChangeChoiceData:o.roleChangeChoice},null,8,["item","data","date","choice","onChangeChoiceData"]),p(w,{ref:"roleapi",item:l.busData.item,data:l.data.operation,date:l.date,choice:l.busData.choiceData.operation,title:"API权限",name:"operation",class:"col-auto-8 m0-10",onChangeChoiceData:o.roleChangeChoice},null,8,["item","data","date","choice","onChangeChoiceData"])]),u("div",S,[p(s,{onClick:t[1]||(t[1]=e=>l.dialogVisible=!1)},{default:c((()=>[F])),_:1}),p(s,{type:"primary",onClick:o.submitFn},{default:c((()=>[N])),_:1},8,["onClick"])])])),_:1},8,["modelValue","title"])])}]]);export{I as default};
